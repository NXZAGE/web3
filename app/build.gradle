plugins {
    id 'java'
    id 'war'
}

def wildflyHome = '/opt/wildfly'
def deployDir = "${wildflyHome}/standalone/deployments/web3.war"
def classesDeployDir = "${deployDir}/WEB-INF/classes"
def markerFilePath = "${deployDir}.dodeploy"

repositories {
    mavenCentral()
}

dependencies {
     // ‚úÖ Jakarta EE 11 API (WildFly —É–∂–µ –∏–º–µ–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
    providedCompile 'jakarta.platform:jakarta.jakartaee-api:11.0.0'
    
    // ‚úÖ PrimeFaces –¥–ª—è Jakarta EE 11 (–≤–µ—Ä—Å–∏—è 13+)
    implementation 'org.primefaces:primefaces:15.0.0:jakarta'
    
    // ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è PrimeFaces 13+
    implementation 'commons-fileupload:commons-fileupload:1.5'
    implementation 'org.owasp.encoder:encoder:1.3.1'

    // OmniFaces
    implementation 'org.omnifaces:omnifaces:4.7.1'

    // JPA/Hibernate/PostgreSQL
    compileOnly 'jakarta.persistence:jakarta.persistence-api:3.2.0'
    implementation 'org.hibernate.orm:hibernate-core:7.1.11.Final'
    runtimeOnly 'org.postgresql:postgresql:42.7.8'

    // Extra Libs
    compileOnly 'org.projectlombok:lombok:1.18.42'
    annotationProcessor 'org.projectlombok:lombok:1.18.42'
    implementation 'ch.qos.logback:logback-classic:1.5.21'
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.20.0'
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

task createClassesDir {
    doLast {
        def classesDir = new File(classesDeployDir)
        if (!classesDir.exists()) {
            classesDir.mkdirs()
        }
    }
}

// –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –∑–∞–¥–∞—á–∞ –¥–ª—è –¥–µ–ø–ª–æ—è Java –∫–ª–∞—Å—Å–æ–≤
task hotDeploy(type: Copy) {
    dependsOn classes, processResources, createClassesDir

    from sourceSets.main.output.classesDirs
    into "${deployDir}/WEB-INF/classes"

    from sourceSets.main.output.resourcesDir
    into "${deployDir}/WEB-INF/classes"

    doLast {
        // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        def marker = new File("${deployDir}.dodeploy")
        if (!marker.exists()) {
            marker.text = ''
        }
        
        println "‚úÖ Deployed at ${new Date()}"
        println "üìÅ Classes: ${deployDir}/WEB-INF/classes"
        println "üîÑ WildFly should auto-reload (check server.log)"
    }
}

task deployAll {
    dependsOn classes, processResources
    
    doLast {
        def DEPLOY = '/opt/wildfly/standalone/deployments/web3.war'
        
        println "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –≤ exploded –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
        
        // 1. –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        delete DEPLOY
        
        // 2. –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
        mkdir "$DEPLOY/WEB-INF/lib"
        mkdir "$DEPLOY/WEB-INF/classes"
        
        // 3. –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏–∫—É (xhtml, css, js –∏ —Ç.–¥.)
        copy {
            from 'src/main/webapp'
            into DEPLOY
            exclude '**/.gitkeep'
        }
        
        // 4. –ö–æ–ø–∏—Ä—É–µ–º —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã
        copy {
            from sourceSets.main.output
            into "$DEPLOY/WEB-INF/classes"
        }
        
        // 5. –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ—Å—É—Ä—Å—ã (persistence.xml, logback.xml –∏ —Ç.–¥.)
        copy {
            from sourceSets.main.resources
            into "$DEPLOY/WEB-INF/classes"
        }
        
        // 6. –ö–æ–ø–∏—Ä—É–µ–º –í–°–ï runtime –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–≤–∫–ª—é—á–∞—è PrimeFaces)
        copy {
            from configurations.runtimeClasspath
            into "$DEPLOY/WEB-INF/lib"
            exclude 'jakarta.platform*.jar' // –ò—Å–∫–ª—é—á–∞–µ–º Jakarta EE API (–µ—Å—Ç—å –≤ WildFly)
            exclude 'jakarta.faces*.jar'    // –ò—Å–∫–ª—é—á–∞–µ–º JSF API (–µ—Å—Ç—å –≤ WildFly)
            exclude '**/jakarta.*.jar'  // –ò—Å–∫–ª—é—á–∞–µ–º Jakarta EE API
            exclude '**/javax.*.jar'    // –ò—Å–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ javax API
        }
        
        // 7. –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        new File("${DEPLOY}.dodeploy").text = ''
        
        // 8. –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö
        def libDir = new File("$DEPLOY/WEB-INF/lib")
        if (libDir.exists()) {
            println "üìö –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:"
            libDir.eachFile { file ->
                println "   - ${file.name} (${file.length()} bytes)"
            }
        }
        
        println "‚úÖ –í—Å—ë –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ $DEPLOY"
        println "üì¶ –í—Å–µ–≥–æ –±–∏–±–ª–∏–æ—Ç–µ–∫: ${libDir.listFiles()?.size() ?: 0}"
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏
task watchStatic {
    doLast {
        println "üëÄ –°–ª–µ–∂—É –∑–∞ webapp..."
        
        def lastCheck = System.currentTimeMillis()
        def webappDir = file('src/main/webapp')
        
        while(true) {
            def changed = false
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –≤ webapp
            fileTree(dir: webappDir).each { file ->
                if (file.lastModified() > lastCheck) {
                    changed = true
                }
            }
            
            if (changed) {
                println "üìù –û–±–Ω–æ–≤–ª—è—é —Å—Ç–∞—Ç–∏–∫—É..."
                copy {
                    from webappDir
                    into '/opt/wildfly/standalone/deployments/web3.war'
                    exclude 'WEB-INF/classes/**'
                }
                lastCheck = System.currentTimeMillis()
            }
            
            sleep(1000)
        }
    }
}